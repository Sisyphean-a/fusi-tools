<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratchpad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
            background-color: var(--vscode-editor-background);
        }
        textarea {
            flex: 1;
            width: 100%;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            border: none;
            outline: none;
            resize: none;
            padding: 8px;
        }
        textarea:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }
        textarea::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }
        .footer {
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--vscode-widget-border);
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            background-color: var(--vscode-editor-background);
        }
        .char-count {
            font-family: var(--vscode-font-family);
        }
        .actions {
            display: flex;
            gap: 8px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: var(--vscode-font-family);
        }
        .btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: 1px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Secondary Button (Standard) */
        .btn-secondary {
            color: var(--vscode-button-secondaryForeground);
            background-color: var(--vscode-button-secondaryBackground);
        }
        .btn-secondary:not(:disabled):hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        /* Destructive State for Secondary Button */
        .btn-secondary.confirm {
            background-color: var(--vscode-button-destructiveBackground);
            color: var(--vscode-button-destructiveForeground);
        }
        .btn-secondary.confirm:hover {
            background-color: var(--vscode-button-destructiveHoverBackground);
        }

        /* Primary Button */
        .btn-primary {
            color: var(--vscode-button-foreground);
            background-color: var(--vscode-button-background);
        }
        .btn-primary:not(:disabled):hover {
            background-color: var(--vscode-button-hoverBackground);
        }
    </style>
</head>
<body>
    <textarea
        id="scratchpad"
        aria-label="Scratchpad Input"
        placeholder="Scratchpad: Type your temporary notes here... (Content is cleared on reload)"
        spellcheck="false"
        autofocus
    ></textarea>
    <div class="footer">
        <span id="char-count" class="char-count">0 chars, 0 lines</span>
        <div class="actions">
            <button id="btn-copy" class="btn btn-primary" aria-label="Copy to Clipboard" title="Copy content to clipboard">
                Copy
            </button>
            <button id="btn-remove-empty" class="btn btn-secondary" aria-label="Remove Empty Lines" title="Remove all empty lines">
                Remove Empty Lines
            </button>
            <button id="btn-clear" class="btn btn-secondary" aria-label="Clear Scratchpad" title="Clear all content">
                Clear
            </button>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const textarea = document.getElementById('scratchpad');
        const charCount = document.getElementById('char-count');
        const btnClear = document.getElementById('btn-clear');
        const btnCopy = document.getElementById('btn-copy');
        const btnRemoveEmpty = document.getElementById('btn-remove-empty');
        let clearTimeoutId;
        let copyTimeoutId;
        let removeEmptyTimeoutId;

        // Debounce function
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function updateCharCount() {
            const length = textarea.value.length;
            const lines = length === 0 ? 0 : textarea.value.split('\n').length;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectionLen = Math.abs(end - start);

            let text = `${length} char${length !== 1 ? 's' : ''}, ${lines} line${lines !== 1 ? 's' : ''}`;
            if (selectionLen > 0) {
                text += ` (${selectionLen} selected)`;
            }
            charCount.textContent = text;
        }

        function updateButtonStates() {
            const hasContent = textarea.value.length > 0;
            btnCopy.disabled = !hasContent;
            btnRemoveEmpty.disabled = !hasContent;
            // Clear button should also be disabled if there's no content
            // However, we need to respect the "confirm" state if it was active,
            // but if content is empty, confirm state is irrelevant as we can't clear empty.
            // If we just cleared it, it becomes disabled.
            btnClear.disabled = !hasContent;

            // If disabled, we should probably reset any pending states (like Confirm?)
            // to avoid weird states when re-enabling.
            if (!hasContent) {
                if (btnClear.dataset.state === 'confirm') {
                    resetClearButton();
                }
            }
        }

        function resetClearButton() {
            if (clearTimeoutId) {
                clearTimeout(clearTimeoutId);
                clearTimeoutId = null;
            }
            btnClear.textContent = 'Clear';
            btnClear.classList.remove('confirm');
            btnClear.setAttribute('aria-label', 'Clear Scratchpad');
            btnClear.dataset.state = 'idle';
        }

        function resetCopyButton() {
            if (copyTimeoutId) {
                clearTimeout(copyTimeoutId);
                copyTimeoutId = null;
            }
            btnCopy.textContent = 'Copy';
            btnCopy.setAttribute('aria-label', 'Copy to Clipboard');
        }

        function resetRemoveEmptyButton() {
            if (removeEmptyTimeoutId) {
                clearTimeout(removeEmptyTimeoutId);
                removeEmptyTimeoutId = null;
            }
            btnRemoveEmpty.textContent = 'Remove Empty Lines';
            btnRemoveEmpty.setAttribute('aria-label', 'Remove Empty Lines');
        }

        // 监听内容变化
        const onInput = debounce(() => {
            vscode.postMessage({
                type: 'contentChanged',
                content: textarea.value
            });
        }, 300);

        textarea.addEventListener('input', () => {
            updateCharCount();
            updateButtonStates();
            onInput();
        });

        // Update stats on selection change
        ['mouseup', 'keyup', 'focus'].forEach(event => {
            textarea.addEventListener(event, updateCharCount);
        });

        // Copy Button Logic
        btnCopy.addEventListener('click', () => {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const hasSelection = start !== end;
            const content = hasSelection ? textarea.value.substring(start, end) : textarea.value;

            if (!content) return;

            vscode.postMessage({
                type: 'copyToClipboard',
                content: content
            });

            const feedbackText = hasSelection ? 'Copied Selection!' : 'Copied!';
            const ariaLabel = hasSelection ? 'Copied Selection to Clipboard' : 'Copied to Clipboard';

            btnCopy.textContent = feedbackText;
            btnCopy.setAttribute('aria-label', ariaLabel);

            if (copyTimeoutId) clearTimeout(copyTimeoutId);
            copyTimeoutId = setTimeout(resetCopyButton, 2000);
        });

        // Clear Button Logic
        btnClear.addEventListener('click', () => {
            if (textarea.value.length === 0) return;

            if (btnClear.dataset.state !== 'confirm') {
                // First click: Request confirmation
                btnClear.textContent = 'Confirm?';
                btnClear.classList.add('confirm');
                btnClear.setAttribute('aria-label', 'Confirm Clear Scratchpad');
                btnClear.dataset.state = 'confirm';

                // Reset after 3 seconds
                clearTimeoutId = setTimeout(resetClearButton, 3000);
            } else {
                // Second click: Perform action
                textarea.value = '';
                updateCharCount();
                updateButtonStates();
                onInput();
                textarea.focus();
                resetClearButton();
            }
        });

        // Remove Empty Lines Button Logic
        btnRemoveEmpty.addEventListener('click', () => {
            const content = textarea.value;
            if (!content) return;

            // 移除所有空行（包括只包含空格和制表符的行）
            const lines = content.split('\n');
            const nonEmptyLines = lines.filter(line => line.trim().length > 0);
            const newContent = nonEmptyLines.join('\n');

            // 如果内容没有变化，不做任何操作
            if (newContent === content) {
                btnRemoveEmpty.textContent = 'No Empty Lines';
                btnRemoveEmpty.setAttribute('aria-label', 'No Empty Lines Found');
            } else {
                textarea.value = newContent;
                updateCharCount();
                updateButtonStates();
                onInput();
                
                const removedCount = lines.length - nonEmptyLines.length;
                btnRemoveEmpty.textContent = `Removed ${removedCount}`;
                btnRemoveEmpty.setAttribute('aria-label', `Removed ${removedCount} empty lines`);
            }

            if (removeEmptyTimeoutId) clearTimeout(removeEmptyTimeoutId);
            removeEmptyTimeoutId = setTimeout(resetRemoveEmptyButton, 2000);
        });

        textarea.addEventListener('focus', resetClearButton);

        // 接收来自扩展的消息
        window.addEventListener('message', (event) => {
            const message = event.data;
            switch (message.type) {
                case 'restoreContent':
                    textarea.value = message.content;
                    updateCharCount();
                    updateButtonStates();
                    break;
            }
        });

        // Initialize button states
        updateButtonStates();
    </script>
</body>
</html>
