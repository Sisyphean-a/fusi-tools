<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratchpad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
            background-color: var(--vscode-editor-background);
        }
        textarea {
            flex: 1;
            width: 100%;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            border: none;
            outline: none;
            resize: none;
            padding: 8px;
        }
        textarea:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }
        textarea::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }
        .footer {
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--vscode-widget-border);
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            background-color: var(--vscode-editor-background);
        }
        .char-count {
            font-family: var(--vscode-font-family);
        }
        .actions {
            display: flex;
            gap: 8px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: var(--vscode-font-family);
        }
        .btn:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: 1px;
        }

        /* Secondary Button (Standard) */
        .btn-secondary {
            color: var(--vscode-button-secondaryForeground);
            background-color: var(--vscode-button-secondaryBackground);
        }
        .btn-secondary:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        /* Destructive State for Secondary Button */
        .btn-secondary.confirm {
            background-color: var(--vscode-button-destructiveBackground);
            color: var(--vscode-button-destructiveForeground);
        }
        .btn-secondary.confirm:hover {
            background-color: var(--vscode-button-destructiveHoverBackground);
        }

        /* Primary Button */
        .btn-primary {
            color: var(--vscode-button-foreground);
            background-color: var(--vscode-button-background);
        }
        .btn-primary:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
    </style>
</head>
<body>
    <textarea
        id="scratchpad"
        aria-label="Scratchpad Input"
        placeholder="Scratchpad: Type your temporary notes here... (Content is cleared on reload)"
        spellcheck="false"
    ></textarea>
    <div class="footer">
        <span id="char-count" class="char-count" aria-live="polite">0 chars</span>
        <div class="actions">
            <button id="btn-copy" class="btn btn-primary" aria-label="Copy to Clipboard" title="Copy content to clipboard">
                Copy
            </button>
            <button id="btn-clear" class="btn btn-secondary" aria-label="Clear Scratchpad" title="Clear all content">
                Clear
            </button>
        </div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const textarea = document.getElementById('scratchpad');
        const charCount = document.getElementById('char-count');
        const btnClear = document.getElementById('btn-clear');
        const btnCopy = document.getElementById('btn-copy');
        let clearTimeoutId;
        let copyTimeoutId;

        // Debounce function
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function updateCharCount() {
            const length = textarea.value.length;
            charCount.textContent = `${length} char${length !== 1 ? 's' : ''}`;
        }

        function resetClearButton() {
            if (clearTimeoutId) {
                clearTimeout(clearTimeoutId);
                clearTimeoutId = null;
            }
            btnClear.textContent = 'Clear';
            btnClear.classList.remove('confirm');
            btnClear.setAttribute('aria-label', 'Clear Scratchpad');
            btnClear.dataset.state = 'idle';
        }

        function resetCopyButton() {
            if (copyTimeoutId) {
                clearTimeout(copyTimeoutId);
                copyTimeoutId = null;
            }
            btnCopy.textContent = 'Copy';
            btnCopy.setAttribute('aria-label', 'Copy to Clipboard');
        }

        // 监听内容变化
        const onInput = debounce(() => {
            vscode.postMessage({
                type: 'contentChanged',
                content: textarea.value
            });
        }, 300);

        textarea.addEventListener('input', () => {
            updateCharCount();
            onInput();
        });

        // Copy Button Logic
        btnCopy.addEventListener('click', () => {
            const content = textarea.value;
            if (!content) return;

            vscode.postMessage({
                type: 'copyToClipboard',
                content: content
            });

            btnCopy.textContent = 'Copied!';
            btnCopy.setAttribute('aria-label', 'Copied to Clipboard');

            if (copyTimeoutId) clearTimeout(copyTimeoutId);
            copyTimeoutId = setTimeout(resetCopyButton, 2000);

            textarea.focus();
        });

        // Clear Button Logic
        btnClear.addEventListener('click', () => {
            if (textarea.value.length === 0) return;

            if (btnClear.dataset.state !== 'confirm') {
                // First click: Request confirmation
                btnClear.textContent = 'Confirm?';
                btnClear.classList.add('confirm');
                btnClear.setAttribute('aria-label', 'Confirm Clear Scratchpad');
                btnClear.dataset.state = 'confirm';

                // Reset after 3 seconds
                clearTimeoutId = setTimeout(resetClearButton, 3000);
            } else {
                // Second click: Perform action
                textarea.value = '';
                updateCharCount();
                onInput();
                textarea.focus();
                resetClearButton();
            }
        });

        textarea.addEventListener('focus', resetClearButton);

        // 接收来自扩展的消息
        window.addEventListener('message', (event) => {
            const message = event.data;
            switch (message.type) {
                case 'restoreContent':
                    textarea.value = message.content;
                    updateCharCount();
                    break;
            }
        });
    </script>
</body>
</html>
